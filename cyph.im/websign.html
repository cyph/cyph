<!DOCTYPE html>
<html manifest='websign.appcache'>
	<head>
		<meta charset='utf-8' />
		<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1' />
		<meta name='google' content='notranslate' />
		<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
		<meta name='apple-mobile-web-app-capable' content='yes' />
		<meta name='mobile-web-app-capable' content='yes' />

		<title>Verifying package signature...</title>

		<link rel='apple-touch-icon' sizes='57x57' href='/img/favicon/apple-touch-icon-57x57.png' />
		<link rel='apple-touch-icon' sizes='114x114' href='/img/favicon/apple-touch-icon-114x114.png' />
		<link rel='apple-touch-icon' sizes='72x72' href='/img/favicon/apple-touch-icon-72x72.png' />
		<link rel='apple-touch-icon' sizes='144x144' href='/img/favicon/apple-touch-icon-144x144.png' />
		<link rel='apple-touch-icon' sizes='60x60' href='/img/favicon/apple-touch-icon-60x60.png' />
		<link rel='apple-touch-icon' sizes='120x120' href='/img/favicon/apple-touch-icon-120x120.png' />
		<link rel='apple-touch-icon' sizes='76x76' href='/img/favicon/apple-touch-icon-76x76.png' />
		<link rel='apple-touch-icon' sizes='152x152' href='/img/favicon/apple-touch-icon-152x152.png' />
		<link rel='apple-touch-icon' sizes='180x180' href='/img/favicon/apple-touch-icon-180x180.png' />
		<link rel='icon' type='image/png' href='/img/favicon/favicon-192x192.png' sizes='192x192' />
		<link rel='icon' type='image/png' href='/img/favicon/favicon-160x160.png' sizes='160x160' />
		<link rel='icon' type='image/png' href='/img/favicon/favicon-96x96.png' sizes='96x96' />
		<link rel='icon' type='image/png' href='/img/favicon/favicon-16x16.png' sizes='16x16' />
		<link rel='icon' type='image/png' href='/img/favicon/favicon-32x32.png' sizes='32x32' />
		<meta name='msapplication-TileColor' content='#8b62d9' />
		<meta name='msapplication-TileImage' content='/img/favicon/mstile-144x144.png' />

		<link rel='stylesheet' href='css/preload.css' />
	</head>
	<body>
		<div id='pre-load'>
			<div class='double-bounce1'></div>
			<div class='double-bounce2'></div>
		</div>

		<script src='js/cryptoInit.js'></script>

		<script>
			/* Detect when the server triggers a local cache wipe and give
				the application the opportunity to show a big scary warning */

			applicationCache.addEventListener('obsolete', function() {
				window.webSignObsolete	= true;
			}, false);
		</script>

		<script src='cryptolib/sha512.js'></script>
		<script src='cryptolib/openpgp/openpgp.min.js'></script>
		<script> openpgp.initWorker('cryptolib/openpgp/openpgp.worker.min.js') </script>

		<script>
			/*** Configuration ***/

			var CONTINENT_URL		= 'https://api.cyph.com/continent';

			var URL_PROTOCOL		= 'https://'
			var DEFAULT_CONTINENT	= 'eu';
			var CDN_URL_BASE		= '.cdn.cyph.com/websign/';
			var HASH_PATH			= 'cyph.im.hash?';
			var PACKAGE_PATH		= 'cyph.im.pkg?';

			var PUBLIC_KEYS			= [
				'-----BEGIN PGP PUBLIC KEY BLOCK-----\nVersion: GnuPG v1\n\n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\nQsR4uXNdGHY6gw==\n=QQvt\n-----END PGP PUBLIC KEY BLOCK-----',
				'-----BEGIN PGP PUBLIC KEY BLOCK-----\nVersion: GnuPG v1.4.11 (GNU/Linux)\n\n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\nA8TI30ELCf0jWFqcArf7SFM9XFQ=\n=WoDX\n-----END PGP PUBLIC KEY BLOCK-----'
			];
		</script>

		<script>
			/*** Helpers ***/

			/* TODO: Do something else */
			function abort (errorMessage) {
				throw new Error('Aborted: ' + errorMessage);
			}

			function request (url, callback, errorHandler, retries) {
				var req		= new XMLHttpRequest();
				req.open('get', url, true);

				req.onreadystatechange = function () {
					if (req.readyState == 4) {
						if (req.status == 200) {
							callback(req.responseText);
						}
						else {
							retries	= retries || 0;

							if (retries > 3) {
								if (errorHandler) {
									errorHandler(req.statusText);
								}
								else {
									callback(null);
								}
							}
							else {
								request(url, callback, errorHandler, retries + 1);
							}
						}
					}
				};

				req.send();
			}


			function getPackage (cdnUrl, errorHandler) {
				if (localStorage.webSignHash) {
					if (!errorHandler) {
						errorHandler	= function (err) {
							abort('payload failed to download ("' + err + '")');
						};
					}

					request(cdnUrl + PACKAGE_PATH + localStorage.webSignHash, function (payload) {
						if (CryptoJS.SHA512(payload).toString() == localStorage.webSignHash) {
							document.open('text/html');
							document.write(payload);
							document.close();
						}
						else {
							errorHandler();
						}
					}, errorHandler);
				}
				else {
					abort('no good hash');
				}
			}

			function makeCdnUrl (continent) {
				window.webSignContinent	= continent || DEFAULT_CONTINENT;
				return URL_PROTOCOL + window.webSignContinent + CDN_URL_BASE;
			}
		</script>

		<script>
			/*** Main ***/

			/* Get user's current location to choose optimal CDN node */
			function main (continent) {
				var cdnUrl	= makeCdnUrl(continent);

				/* Get latest signed hash */
				request(cdnUrl + HASH_PATH + Date.now(), function (signedHashText) {
					var previousHash	= localStorage.webSignHash;

					try {
						var signedHash		= openpgp.cleartext.readArmored(signedHashText);
						var hashText		= signedHash.getText();

						/* If different from previous known good hash,
							validate signature before accepting it */
						if (hashText != previousHash) {
							var isValid	= PUBLIC_KEYS.
								map(function (key) { return signedHash.verify(openpgp.key.readArmored(key).keys)[0].valid }).
								reduce(function (a, b) { return a || b })
							;

							if (isValid) {
								localStorage.webSignHash	= hashText;
							}
						}
					}
					catch (e) {}

					/* Get latest package and compare hashes before executing;
						if hashes differ, try falling back to last known good package,
						then if that fails retry everything with default fallback CDN node,
						then finally abort if that still fails */
					getPackage(cdnUrl, function () {
						if (previousHash) {
							localStorage.webSignHash	= previousHash;
						}

						getPackage(cdnUrl, function () {
							if (continent) {
								main();
							}
							else {
								abort('payload is bad');
							}
						});
					});
				});
			}

			request(CONTINENT_URL, main);
		</script>
	</body>
</html>
