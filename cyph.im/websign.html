<!DOCTYPE html>
<html manifest='cyph.appcache'>
	<head>
		<meta charset='utf-8' />
		<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1' />
		<meta name='google' content='notranslate' />
		<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
		<meta name='apple-mobile-web-app-capable' content='yes' />
		<meta name='mobile-web-app-capable' content='yes' />

		<title>Cyph &ndash; Encrypted Messenger</title>

		<link rel='apple-touch-icon' sizes='57x57' href='/img/favicon/apple-touch-icon-57x57.png' />
		<link rel='apple-touch-icon' sizes='114x114' href='/img/favicon/apple-touch-icon-114x114.png' />
		<link rel='apple-touch-icon' sizes='72x72' href='/img/favicon/apple-touch-icon-72x72.png' />
		<link rel='apple-touch-icon' sizes='144x144' href='/img/favicon/apple-touch-icon-144x144.png' />
		<link rel='apple-touch-icon' sizes='60x60' href='/img/favicon/apple-touch-icon-60x60.png' />
		<link rel='apple-touch-icon' sizes='120x120' href='/img/favicon/apple-touch-icon-120x120.png' />
		<link rel='apple-touch-icon' sizes='76x76' href='/img/favicon/apple-touch-icon-76x76.png' />
		<link rel='apple-touch-icon' sizes='152x152' href='/img/favicon/apple-touch-icon-152x152.png' />
		<link rel='apple-touch-icon' sizes='180x180' href='/img/favicon/apple-touch-icon-180x180.png' />
		<link rel='icon' type='image/png' href='/img/favicon/favicon-192x192.png' sizes='192x192' />
		<link rel='icon' type='image/png' href='/img/favicon/favicon-160x160.png' sizes='160x160' />
		<link rel='icon' type='image/png' href='/img/favicon/favicon-96x96.png' sizes='96x96' />
		<link rel='icon' type='image/png' href='/img/favicon/favicon-16x16.png' sizes='16x16' />
		<link rel='icon' type='image/png' href='/img/favicon/favicon-32x32.png' sizes='32x32' />
		<meta name='msapplication-TileColor' content='#8b62d9' />
		<meta name='msapplication-TileImage' content='/img/favicon/mstile-144x144.png' />

		<link rel='stylesheet' href='websign/css/loading.css' />
	</head>
	<body>
		<div id='pre-load'>
			<div class='double-bounce1'></div>
			<div class='double-bounce2'></div>
			<div class='message'>
				<p>
					Validating cryptographic signature...
				</p>
				<p>
					Please wait; this may take a few seconds.
				</p>
			</div>
		</div>

		<script src='websign/js/cryptoInit.js'></script>
		<script src='websign/js/webSignPublicKeys.js'></script>

		<script src='websign/lib/sha512.js'></script>
		<script src='websign/lib/openpgp/openpgp.min.js'></script>
		<script> openpgp.initWorker('websign/lib/openpgp/openpgp.worker.min.js') </script>

		<script>(function () {
			/* Detect if WebSign bootstrap has changed */

			function detectWebSignInvalidation () {
				var WEBSIGN_FILES	= [
					'cyph.appcache',
					'index.html',
					'websign/css/loading.css',
					'websign/js/cryptoInit.js',
					'websign/js/webSignPublicKeys.js',
					'websign/js/workerHelper.js',
					'websign/lib/sha512.js',
					'websign/lib/openpgp/openpgp.min.js',
					'websign/lib/openpgp/openpgp.worker.min.js'
				];

				var bootstrapText	= '';

				for (var i = 0 ; i < WEBSIGN_FILES.length ; ++i) {
					var req	= new XMLHttpRequest();
					req.open('get', WEBSIGN_FILES[i], false);
					req.send();
					bootstrapText	+= req.responseText;
				}

				var bootstrapHash	= CryptoJS.SHA512(bootstrapText).toString();

				if (localStorage.webSignBootHash && localStorage.webSignBootHash != bootstrapHash) {
					window.webSignWarn	= true;
				}

				localStorage.webSignBootHashOld	= localStorage.webSignBootHash;
				localStorage.webSignBootHash	= bootstrapHash;
			}

			applicationCache.addEventListener('error', detectWebSignInvalidation, false);
			applicationCache.addEventListener('obsolete', detectWebSignInvalidation, false);
			applicationCache.addEventListener('updateready', detectWebSignInvalidation, false);



			/*** Configuration ***/

			var isOnion				= document.location.host.split('.').slice(-1)[0] == 'onion';

			var CONTINENT_URL		= isOnion ? '' : 'https://api.cyph.com/continent';

			var URL_PROTOCOL		= isOnion ? '' : 'https://'
			var DEFAULT_CONTINENT	= isOnion ? '' : 'eu';
			var CDN_URL_BASE		= isOnion ? '/cdn/websign/' : '.cdn.cyph.com/websign/';
			var HASH_PATH			= 'cyph.im.hash2?';
			var PACKAGE_PATH		= 'cyph.im.pkg?';



			/*** Helpers ***/

			function abort () {
				document.location.href	= (isOnion ? '' : 'https://www.cyph.com') + '/404';
			}

			function request (url, callback, errorHandler, retries) {
				var req		= new XMLHttpRequest();
				req.open('get', url, true);

				req.onreadystatechange = function () {
					if (req.readyState == 4) {
						if (req.status == 200) {
							callback(req.responseText);
						}
						else {
							retries	= retries || 0;

							if (retries > 3) {
								if (errorHandler) {
									errorHandler(req.statusText);
								}
								else {
									callback(null);
								}
							}
							else {
								request(url, callback, errorHandler, retries + 1);
							}
						}
					}
				};

				req.send();
			}


			function getPackage (cdnUrl, errorHandler) {
				if (!errorHandler) {
					errorHandler	= function () {
						/* Package failed to download */
						abort();
					};
				}

				if (localStorage.webSignHash && parseInt(localStorage.webSignHashExpires, 10) > Date.now()) {
					request(cdnUrl + PACKAGE_PATH + localStorage.webSignHash, function (payload) {
						if (CryptoJS.SHA512(payload).toString() == localStorage.webSignHash) {
							detectWebSignInvalidation();

							document.open('text/html');
							document.write(payload);
							document.close();
						}
						else {
							errorHandler();
						}
					}, errorHandler);
				}
				/* Hash is bad or outdated */
				else {
					errorHandler();
				}
			}

			function makeCdnUrl (continent) {
				window.webSignContinent	= continent || DEFAULT_CONTINENT;
				return URL_PROTOCOL + window.webSignContinent + CDN_URL_BASE;
			}



			/*** Main ***/

			/* Get user's current location to choose optimal CDN node */
			function main (continent) {
				var cdnUrl	= makeCdnUrl(continent);

				/* Get latest signed hash */
				request(cdnUrl + HASH_PATH + Date.now(), function (signedHashText) {
					var previousHash			= localStorage.webSignHash;
					var previousHashTimestamp	= parseInt(localStorage.webSignHashTimestamp, 10);
					var previousHashExpires		= parseInt(localStorage.webSignHashExpires, 10);

					try {
						var signedHashes	= [];

						signedHashes.push(openpgp.cleartext.readArmored(signedHashText));
						signedHashes.push(openpgp.cleartext.readArmored(signedHashes[0].getText()));

						var o				= JSON.parse(signedHashes[1].getText());
						var hashText		= o.hash;
						var hashTimestamp	= o.timestamp;
						var hashExpires		= o.expires;

						/* If not expired and more recent than previous known good hash,
							validate signatures before accepting it */
						if (
							(!previousHashTimestamp || hashTimestamp > previousHashTimestamp) &&
							hashExpires > Date.now()
						) {
							var isValid	= signedHashes
								.map(function (signedHash) {
									for (var i = 0 ; i < PUBLIC_KEYS.length ; ++i) {
										if (
											signedHash.verify(
												openpgp.key.readArmored(PUBLIC_KEYS[i]).keys
											)[0].valid
										) {
											return true;
										}
									}

									return false;
								}).
								reduce(function (a, b) { return a || b })
							;

							if (isValid) {
								localStorage.webSignHash			= hashText;
								localStorage.webSignHashTimestamp	= hashTimestamp;
								localStorage.webSignHashExpires		= hashExpires;
							}
						}
					}
					catch (e) {}

					/* Get latest package and compare hashes before executing;
						if hashes differ, try falling back to last known good package,
						then if that fails retry everything with default fallback CDN node,
						then finally abort if that still fails */
					getPackage(cdnUrl, function () {
						if (previousHash && previousHashTimestamp && previousHashExpires) {
							localStorage.webSignHash			= previousHash;
							localStorage.webSignHashTimestamp	= previousHashTimestamp;
							localStorage.webSignHashExpires		= previousHashExpires;
						}

						getPackage(cdnUrl, function () {
							if (continent) {
								main();
							}
							else {
								/* Package is bad */
								abort();
							}
						});
					});
				});
			}

			if (isOnion) {
				main();
			}
			else {
				request(CONTINENT_URL, main);
			}

		}());</script>
	</body>
</html>
