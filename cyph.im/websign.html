<!DOCTYPE html>
<html manifest='websign.appcache'>
	<body>
		<script src='js/cryptoPolyfill.js'></script>

		<script>
			applicationCache.addEventListener('obsolete', function() {
				window.webSignObsolete	= true;
			}, false);
		</script>

		<script src='cryptolib/openpgp/openpgp.min.js'></script>
		<script> openpgp.initWorker('cryptolib/openpgp/openpgp.worker.min.js') </script>

		<script>
			/*** Configuration ***/

			var HASH_URL	= '/cyph.im.hash';
			var PACKAGE_URL	= '/cyph.im.pkg';
			var PUBLIC_KEY	= '-----BEGIN PGP PUBLIC KEY BLOCK-----\nVersion: GnuPG v1\n\n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\nQsR4uXNdGHY6gw==\n=QQvt\n-----END PGP PUBLIC KEY BLOCK-----';
		</script>

		<script>
			/*** Helpers ***/

			/* TODO: Do something else */
			function abort () {
				throw new Error('Aborted');
			}

			function hash (data) {
				return openpgp.crypto.hash.sha512(data).split('').map(function (s) {
					return ('0' + s.charCodeAt(0).toString(16)).substr(-2);
				}).join('')
			}

			function request (url, callback) {
				var req		= new XMLHttpRequest();
				req.onload	= function () {
					callback(req.responseText);
				};
				req.open('get', url, true);
				req.send();
			}
		</script>

		<script>
			/*** Main ***/

			request(HASH_URL, function (response) {
				var signedHash	= openpgp.cleartext.readArmored(response);
				var hashText	= signedHash.getText();

				if (hashText != localStorage.webSignHash) {
					if (signedHash.verify(openpgp.key.readArmored(PUBLIC_KEY).keys)[0].valid) {
						localStorage.webSignHash	= hashText;
					}
				}

				if (localStorage.webSignHash) {
					request(PACKAGE_URL + '?' + localStorage.webSignHash, function (payload) {
						if (hash(payload) == localStorage.webSignHash) {
							document.open('text/html');
							document.write(payload);
							document.close();
						}
						else {
							abort();
						}
					});
				}
				else {
					abort();
				}
			});
		</script>
	</body>
</html>
