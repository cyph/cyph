<!DOCTYPE html>
<html manifest='websign/appcache.appcache'>
	<head>
		<meta charset='utf-8' />
		<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1' />
		<meta name='google' content='notranslate' />
		<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
		<meta name='apple-mobile-web-app-capable' content='yes' />
		<meta name='mobile-web-app-capable' content='yes' />
		<meta name='referrer' content='no-referrer' />
		<link rel='manifest' href='manifest.json' />

		<title>Cyph &ndash; Encrypted Messenger</title>

		<link rel='icon' sizes='192x192' type='image/png' href='/img/favicon/favicon-192x192.png' />
		<link rel='icon' sizes='160x160' type='image/png' href='/img/favicon/favicon-160x160.png' />
		<link rel='icon' sizes='96x96' type='image/png' href='/img/favicon/favicon-96x96.png' />
		<link rel='icon' sizes='32x32' type='image/png' href='/img/favicon/favicon-32x32.png' />
		<link rel='icon' sizes='16x16' type='image/png' href='/img/favicon/favicon-16x16.png' />
		<link rel='apple-touch-icon' sizes='180x180' type='image/png' href='/img/favicon/apple-touch-icon-180x180.png' />
		<link rel='apple-touch-icon' sizes='152x152' type='image/png' href='/img/favicon/apple-touch-icon-152x152.png' />
		<link rel='apple-touch-icon' sizes='144x144' type='image/png' href='/img/favicon/apple-touch-icon-144x144.png' />
		<link rel='apple-touch-icon' sizes='120x120' type='image/png' href='/img/favicon/apple-touch-icon-120x120.png' />
		<link rel='apple-touch-icon' sizes='114x114' type='image/png' href='/img/favicon/apple-touch-icon-114x114.png' />
		<link rel='apple-touch-icon' sizes='76x76' type='image/png' href='/img/favicon/apple-touch-icon-76x76.png' />
		<link rel='apple-touch-icon' sizes='72x72' type='image/png' href='/img/favicon/apple-touch-icon-72x72.png' />
		<link rel='apple-touch-icon' sizes='60x60' type='image/png' href='/img/favicon/apple-touch-icon-60x60.png' />
		<link rel='apple-touch-icon' sizes='57x57' type='image/png' href='/img/favicon/apple-touch-icon-57x57.png' />
		<meta name='msapplication-TileImage' content='/img/favicon/mstile-144x144.png' />
		<meta name='msapplication-TileColor' content='#8b62d9' />
		<meta name='theme-color' content='#8b62d9' />

		<link rel='stylesheet' href='websign/css/websign.css' />
	</head>
	<body>
		<div id='pre-load'>
			<div class='double-bounce1'></div>
			<div class='double-bounce2'></div>

			<div id='pre-load-message' class='message'>
				<p>
					Validating application integrity...
				</p>
				<p>
					Please wait; this may take a few seconds.
				</p>
			</div>

			<div id='panic-message' class='message' style='display: none'>
				<div>
					<h3>
						<strong>WARNING:</strong>
						Validation Failure
					</h3>
					<div class='left'>
						<p>
							Common reasons for this:
						</p>
						<ol>
							<li>
								You're using Cyph in Chrome on iOS. On iOS,
								Chrome tampers with your connection.
								<br />
								<strong>Fix:</strong>
								Use Safari on iOS.
							</li>
							<li>
								Your antivirus software tampers with your Internet connection.
								<br />
								<strong>Fix:</strong>
								This "feature" is a security risk. Disable it.
							</li>
						</ol>
					</div>
					<p>
						If neither of these apply to you,
						<strong>DO NOT refresh this page or otherwise continue to use Cyph</strong>.
						If possible, cease using this device entirely.
					</p>
					<p>
						<strong><a
							href='mailto:%22Ryan%20and%20Josh%22%20%3Cwebsign@cyph.com%3E?subject=I%20RECEIVED%20THE%20WEBSIGN%20WARNING&body=Hello%20Ryan%20and%20Josh%2C%0A%0A'
						>Email us immediately</a></strong>;
						we will investigate and advise on how to proceed.
						<strong>
							DO NOT trust any reply that isn't signed using
							<a
								target='_blank'
								href='data:text/plain;base64,LS0tLS1CRUdJTiBQR1AgUFVCTElDIEtFWSBCTE9DSy0tLS0tClZlcnNpb246IEdudVBHIHYxCgptUUlOQkZhYWx0OEJFQUMrNGxyT2sxMWVnY2tzWUR5cmJISjF5SzZnTk81aGx2M29ZNGY1TTlvbGpoWVNsZnZqCmZiQXMvUE9Hb1lLZmhWS1Eva1pMdlpXLy9EL3k4U1Bza1JTc2ZjZlJWR3c3NDFVbXRTRUI2YUJZenBMQTFCc0gKa2RmUGhBRjBPeXhRVHBmc2lVWndqZWFIS2FKNkxXNDV2Njc2bmVrc1l1VGtidW01TGFMWnE1TklqL2VKSjlWcgpxcjdKQjZtYnZtZ2hySDdZUHl0TXZzVHc5VTZTMzQzbnFYN0JiU04ydUordXdINHE0UTR3czlEQnNGeXlDWlpHCjV0ZWZ1U1Yya1NCRk9IZnpMZkJiRWp5Tm80Z3V2dWhOSmZ3VGZSN1Z2cDNkZE1VRU1SS09SNXJKZ2xjSmZrS3oKYXVmTGV4RlJHQ2NISTZvbUxkOFZ3NStIMU1kUnQyNnhOakVDcXR0d1J6c0taVWdiQTRpUWJ0UDVHZzZEZG03Ugo4QlkwTVhPQXRzUmIwdkRDNmJyM25aRFd5d3VYSWhCTmx4VC9hcTZIV0l1RXdCcVV3V3ZEYXVtL2Z0ZCt5R2huCjd3SWRSVHlvQzJxNUlxT201S2tzOTNmWGVrV2tQV1hoT3lPQ3h6VXY4czBybFdkOE1KYnVKaURoRDdnREpQQ0QKNzJwK2twM2llc1ZsWlNxM29nRjdQckpSblE4Z3EvOERsdUNJWCtSZHBqZitXZGVlcXI5TittSitNbVlnQmlWWApQbmtBNERpS0xtQ3NwNVAySkU4aklmZmw2Q21rOEZudG00M3FBaTRaZHdLZGRYUDlqMElyOXpOZVgrbDNkeFJiCjFYTTNMWmEwVTMzOE9PNHBKNGlNTVVaNlQzNTlsL3gyTHE5L0JWL2ZseGsvTElRZ3RPR0V5bkU5a3dBUkFRQUIKdEVaU2VXRnVJRXhsYzNSbGNpQW1JRUpoY205dUlFcHZjMmgxWVNCRGVYSjFjeUJDYjJWb2JTQW9RM2x3YUN3ZwpTVzVqTGlrZ1BIZGxZbk5wWjI1QVkzbHdhQzVqYjIwK2lRSTRCQk1CQWdBaUJRSldtcGJmQWhzREJnc0pDQWNECkFnWVZDQUlKQ2dzRUZnSURBUUllQVFJWGdBQUtDUkE1WFp3SDVDU3FBS3E5RC80d0xqYjBMTVNmcXRCVDk2RU4KTGlSTU12VURyM0lxVk9Ca29CVUZjZjFLQ3FYRTF5cmJOZXI5UXNoWHlnZjAvVFA4L1ByME1mdGhEM0NNZXBjbwplTzhzcERnNndmbC84YVYxODBnSmZQcC9acVMrSTR1VGMwUVVFS2tmMkpmVUszbXlHZnFCVkNaNm5EWmJ0UFZXCjdaREh1WVJsQWtyYU1adytmbzdZeUJpbzRSZ214N00rNmZqcS9wV25sUk9DUG1DbGZ4U0JKS0QzdkIxbmxXT3kKbmJVZUJzMVRDK0lVMjZKSHlzUUtkdUhSQm1KK1E4Q0c5OXFpMm5PZUxzb3dwNW84RFRHZHRvMjRKWmdBZ3lyWQpRbGg2N1B3SHF6TFBCQk4xNkRTc3EyY0RnSktieEdPcGNodENKMElvSit3Wmt2Qnk0NGxBL1VTclBZTUR6eDdYCkpoc1RoMWQ2cUQ1MEVJbkYxSnl6R1FkSzhSM3JRSThySXdYZjU5TzhlS3dCa3duUTc3QXVsUGUwUk1QelQ1VksKR1NxWmw5VnV3NTlMaDk5R09UMm5FdCtOV1FmOEY5WHJnUnlkYkhEY1I0bnlQemptZHR5aXBnVUhUTytIQkRmSAp2Tk5RU1ZpZWJwNGRoS0V3M244b280MDdGeklRZ1ZKeE9FekpraXR0cldHbHovb3ZxZktOSjVPR1I1SnI0b0pkCmRGVTc2Z043aXhhZUtJdUhnak5iMjlyY3FxNVllUmViUXJxVDdUQ04zUDV3ZWpFc2ZoVVhQZEFKdlpjM1NvREsKSDBmVkxKSmNab3kyV0E0MXJWWk5odzRvNHBhdGtyUnM5WWhYd254L1V0bVZiNFhpRlZoTEJzQzhhK2FhUjVMZgovR3Z6VFdNSDh3RUMxM3FreEdTSTZpOUp4N2tDRFFSV21wYmZBUkFBcWZKU0hGMHZ5RHVlZHlGVTczbVRLY0cxCjhrQlhHNDV4RnhGOWFKbUZrUlJ3YlZyZWFHZ1ZSdW9Ba2hkWmJXRG5za0FqYm9oRFhqQkIwYW9wc05lT2JMak0KMS9zUHlZUGc3UGJ1eEZXa1JKcld5Q1BWVXMrSDZkVG1wRWhWWkUxZDQ4eGZad2NiN3AzRDFOTDlCczdiUmFoYgp3Qk1uY09WZC8zbUEvTnVqRXV4czBrZm41eldSRStaMDdoQlRxZS9tbCtxRmJkeWtubWNGeUdpTkpVVENLNXVrCll5b1YrMFR2bFhwN3E5aGRBQ2FkTHRhOHQwdkJTcUwvL1ZzVE5NTUduZCszRnZyazZ2SmNxL0RwS3N1OHp6SmQKcW8wRmZBNHI4UDNveG1iWUdMR0YvVEh3cmlVWHBiZEFpelFzZjFuREhLWTZvZmtEOGpoYmJhN0VQalo1NmtSTQpxREsxekNYcTJhOHkyeWw4TVdBWnJ0b0JiOXR5WkV6d2lyenAyWDB0eVlBSEJ2RHdvUHk3UURRLzNRdUU3alZaClJnN2NEVjU0OEM0WVJXZmZWMkVucUVZcWREMGdTRGxoQXRZWVBXMlJ1clBiV3dMWG9wOWF3SGRvbmFyRXVIRDcKcFU1Uks1MkxpTXZ2ZHY5QTJ0clo3RFlQOWs5UXlvVEErQmdzeTc2Sk5BSTFjS1hpOXo2cXlCS0ZmNk41RkduaApmeGpzQ2ZvczlLWUV3TmFMQ3cwU2xLN1VRZUZDUDJTQ3lyeVRMZEZjeEUweW9LUUF1Ti9DQTd2c0JOUXAzQVg1ClNtZTVpdnF1aE9YZXJpNXFoRDEwb1pmRk5PQ1kyakJFRURVWmxqR005d2I5Yms0anpoRGN0NURtaXJqTHprSkIKMlRKRlRvaWFDQ01YOXBYZWhZa0FFUUVBQVlrQ0h3UVlBUUlBQ1FVQ1ZwcVczd0liREFBS0NSQTVYWndINUNTcQpBT0JyRC93SUVXVlc4T0pvN2R0bnNDNDJYNFAwczB2UWltZXZCL2xwZG5RK21qaGJxbk4yOUFBMTlEQ1Vzd2dSClMreVA3bEErbUx3NnJTUGcwZm1CbDFMeEdLR0dqWG85QmNKVndmRWd3MUtTZXE3Q0Z6T0VETG5id0xUTnJqcnMKamNSL0hYR2NWNkJwSW52b2RBN0kyVytqTndCSUorWE1oQTJIY2NTVHZTZW55ZVRiMWtGK0FQUDZzYi9CcDN1RAp1bnIzd3c0ajNOR0YrNEJJQXJXd2RtUlR1bEYvVjhSRjZzR0ZiSm1JU29xRFcwVmVMY3oyOWllWFo2eHA5VWJWCms3M3poUjBEeVhudWxSdkxPNWxBQW1vMXRmZXErWWVpeFdtblY4dCtDNDk5ZFNyRit6MExsZXZ3TWM0UmdwVEIKSWJFM09WMVJneHFGTXBDSUJwQ3NKVE56L1ZoN202LzJyY09LcDFQZjFySndKbGw2T2h3cTVabG5pSkNMdXJtSApIYzFXd1NTaG05WTJNeFVIU1BDSHhHOVlkYk9OVXBCeUVRSThlcEhWOXpUQkR4TjVVaWdTeXNZS0N4SHpYaDFHCmZTQmNwbG4vK29hM29QTGd6cms0TUwxUXZMbHFqK3Z4MU5PRk1RdGdHWFh6VXVGTEFJU243elBUN2kzSkhzWmcKM3cwMjJ6NDlhMXFPZUFqcW5qOUNDM1hXNndQRnJnS0Y1S0N2aEVPWlluMzcxR0VIT0QxUlhwMjRHSkpwQ0JmZApqajdObmQzVjU3UXY1bjlYeDBsbFg4ZUdUbWRVNTBQbHJsN0hKZXErckhCNXdwWUkxVVRzaVBEQjI1K2JoeVBFCnEwdUVyQUQzaFNnalVNeXpuRXhlZ0JPOVVTT2hDZU02YkdBWW5iVU45eE9TTDFjdDBnPT0KPUl0S2UKLS0tLS1FTkQgUEdQIFBVQkxJQyBLRVkgQkxPQ0stLS0tLQo='
							>this PGP key</a>.</strong>
					</p>
				</div>
			</div>
		</div>

		<script src='websign/js/crypto.js'></script>
		<script src='websign/js/keys.js'></script>
		<script src='websign/lib/nacl.js'></script>
		<script src='websign/js/sha256.js'></script>

		<script>(function () {


		if (location.host.indexOf('www.') === 0) {
			location.host	= location.host.replace('www.', '');
		}
		else if (
			location.host === '$PROJECT' &&
			LocalStorage.isPersistent &&
			!LocalStorage.webSignWWWPinned
		) {
			LocalStorage.webSignWWWPinned	= true;
			location.host					= 'www.' + location.host;
		}


		window.WebSign	= {
			bootstrapText: '',

			cdnUrl: '',

			continent: '',

			isOnion: document.location.host.split('.').slice(-1)[0] === 'onion',

			config: {
				abortText: 'Loading Cyph failed. Please try again later.',
				cdnUrlBase: '.cdn.cyph.com/websign/',
				continentUrl: 'https://api.cyph.com/continent',
				defaultContinent: 'eu',
				hashPath: '$PROJECT.sig',
				packagePath: '$PROJECT.pkg',
				urlProtocol: 'https://',

				files: [
					'./',
					'websign/js/workerhelper.js',
					'websign/appcache.appcache',
					'websign/manifest.json',
					'serviceworker.js',
					'unsupportedbrowser'
				],

				publicKeys: PUBLIC_KEYS
			},

			loadBootstrapText: function (callback, bootstrapText, i) {
				bootstrapText	= bootstrapText || '';
				i				= i || 0;

				var file	= WebSign.config.files[i];

				request({
					url: file,
					success: function (data) {
						bootstrapText	+= file + ':\n\n' + data + '\n\n\n\n\n\n';

						++i;

						if (i >= WebSign.config.files.length) {
							WebSign.bootstrapText	= bootstrapText;

							Sha256(WebSign.bootstrapText, function (hash) {
								LocalStorage.webSignBootHashOld	= LocalStorage.webSignBootHash;
								LocalStorage.webSignBootHash	= hash;

								callback();
							});
						}
						else {
							WebSign.loadBootstrapText(callback, bootstrapText, i);
						}
					}
				});
			},

			shouldRetry: function () {
				return !(
					WebSign.isOnion ||
					WebSign.continent === WebSign.config.defaultContinent
				);
			},

			stringify: function (shouldIncludeBootstrapText) {
				return (
					'\n\ncontinent: ' + WebSign.continent +
					'\n\ncurrent bootstrap hash: ' + LocalStorage.webSignBootHash +
					'\n\nprevious bootstrap hash: ' + LocalStorage.webSignBootHashOld +
					'\n\npackage hash: ' + LocalStorage.webSignHash +
					(
						shouldIncludeBootstrapText ?
							('\n\n\n\n' + WebSign.bootstrapText) :
							''
					)
				);
			}
		};

		if (WebSign.isOnion) {
			WebSign.config.cdnUrlBase		= '/cdn/websign/';
			WebSign.config.continentUrl		= '';
			WebSign.config.defaultContinent	= '';
			WebSign.config.urlProtocol		= '';
		}


		/*** Main ***/

		try {
			navigator.serviceWorker.
				register('serviceworker.js').
				catch(function () {})
			;
		}
		catch (_) {}

		WebSign.loadBootstrapText(function () {
			if (WebSign.isOnion) {
				main();
			}
			else {
				/* Get user's current location to choose optimal CDN node */
				request({
					url: WebSign.config.continentUrl,
					success: main
				});
			}
		});

		function main (continent) {
			setCdnContinent(continent);

			/* Get latest signed hash */
			var requestArgs	= {
				url: WebSign.cdnUrl + WebSign.config.hashPath,
				data: Date.now(),
				error: function () {
					if (WebSign.shouldRetry()) {
						setCdnContinent();
						requestArgs.url	= WebSign.cdnUrl + WebSign.config.hashPath;
						request(requestArgs);
					}
					else {
						abort();
					}
				},
				success: function (signature) {
					var previousHash			= LocalStorage.webSignHash;
					var previousHashTimestamp	= parseInt(LocalStorage.webSignHashTimestamp, 10);
					var previousHashExpires		= parseInt(LocalStorage.webSignHashExpires, 10);

					try {
						var signatureLines		= signature.split('\n');
						var signatureTimestamp	= parseInt(signatureLines[3], 10);

						var outerKey	= WebSign.config.publicKeys[parseInt(signatureLines[1], 10)];
						var innerKey	= WebSign.config.publicKeys[parseInt(signatureLines[2], 10)];

						/* Ignore unless more recent than previous known good
							hash and signed with two different keys */
						if (
							(!previousHashTimestamp || signatureTimestamp > previousHashTimestamp) &&
							(outerKey && innerKey && outerKey !== innerKey)
						) {
							var outerSignature	= nacl.util.decodeHex(signatureLines[0]);

							var innerSignature	= nacl.util.decodeHex(
								nacl.util.encodeUTF8(
									nacl.sign.open(
										outerSignature,
										new Uint8Array(outerKey)
									)
								)
							);

							var hashObject	= JSON.parse(
								nacl.util.encodeUTF8(
									nacl.sign.open(
										innerSignature,
										new Uint8Array(innerKey)
									)
								)
							);

							/* Accept if valid signature, not expired, and
								detached timestamp was accurate */
							if (
								hashObject.expires > Date.now() &&
								hashObject.timestamp === signatureTimestamp
							) {
								var applyUpdate	= true;

								if (LocalStorage.webSignManualUpgrades) {
									if (confirm('Update to package with hash ' + hashObject.hash + '?')) {
										alert('Applying update.');
									}
									else {
										alert('Update rejected.');
										applyUpdate	= false;
									}
								}

								if (applyUpdate) {
									LocalStorage.webSignHash			= hashObject.hash;
									LocalStorage.webSignHashTimestamp	= hashObject.timestamp;
									LocalStorage.webSignHashExpires		= hashObject.expires;

									LocalStorage.webSignBootHashWhitelist	=
										JSON.stringify(hashObject.webSignBootHashWhitelist)
									;
								}
							}
						}
					}
					catch (_) {}

					/* Show big scary warning if WebSign has been compromised */
					try {
						var webSignBootHashWhitelist	= JSON.parse(LocalStorage.webSignBootHashWhitelist);

						if (!webSignBootHashWhitelist[LocalStorage.webSignBootHash]) {
							panic();
							return;
						}
					}
					catch (_) {}

					/* Get latest package and compare hashes before executing;
						if hashes differ, try falling back to last known good package,
						then if that fails retry everything with default fallback CDN node,
						then finally abort if that still fails */
					loadPackage(function () {
						if (previousHash && previousHashTimestamp && previousHashExpires) {
							LocalStorage.webSignHash			= previousHash;
							LocalStorage.webSignHashTimestamp	= previousHashTimestamp;
							LocalStorage.webSignHashExpires		= previousHashExpires;
						}

						loadPackage(WebSign.shouldRetry() ? main : abort);
					});
				}
			};

			request(requestArgs);
		}


		/*** Helpers ***/

		function abort () {
			var preLoad			= document.getElementById('pre-load');
			var preLoadMessage	= document.getElementById('pre-load-message');

			while (true) {
				var child	= preLoad.children[0];

				if (child === preLoadMessage) {
					break;
				}
				else {
					preLoad.removeChild(child);
				}
			}

			preLoadMessage.innerText	= WebSign.config.abortText;
		}

		function getValue (o, k, defaultValue) {
			return k in o ? o[k] : defaultValue;
		}

		function panic () {
			var preLoad			= document.getElementById('pre-load');
			var panicMessage	= document.getElementById('panic-message');

			while (true) {
				var child	= preLoad.children[0];

				if (child === panicMessage) {
					break;
				}
				else {
					preLoad.removeChild(child);
				}
			}

			panicMessage.style.display	= 'block';

			/* Also try to warn us, though in a serious attack this may be blocked */
			request({
				method: 'POST',
				url: 'https://mandrillapp.com/api/1.0/messages/send.json',
				contentType: 'application/json',
				data: JSON.stringify({
					key: 'HNz4JExN1MtpKz8uP2RD1Q',
					message: {
						from_email: 'test@mandrillapp.com',
						to: [{
							email: 'errors@cyph.com',
							type: 'to'
						}],
						autotext: 'true',
						subject: 'CYPH: SOMEONE JUST GOT THE WEBSIGN ERROR SCREEN LADS',
						text:
							navigator.language + '\n\n' +
							navigator.userAgent + '\n\n' +
							location.toString().replace(/\/#.*/g, '') + '\n\n' +
							WebSign.stringify(true)
					}
				})
			});
		}

		function request (o) {
			var contentType	= getValue(o, 'contentType', 'application/x-www-form-urlencoded');
			var data		= getValue(o, 'data', '');
			var error		= getValue(o, 'error', abort);
			var method		= getValue(o, 'method', 'GET');
			var retries		= getValue(o, 'retries', 3);
			var success		= getValue(o, 'success', function () {});
			var url			= o.url;

			if (data && method === 'GET') {
				url	+= '?' + data;
			}

			var xhr	= new XMLHttpRequest();

			xhr.onreadystatechange	= function () {
				if (xhr.readyState === 4) {
					if (xhr.status === 200) {
						success(xhr.responseText);
					}
					else if (retries > 0) {
						o.retries	= retries - 1;
						request(o);
					}
					else {
						error(xhr.responseText);
					}
				}
			};

			xhr.open(method, url, true);
			xhr.setRequestHeader('Content-Type', contentType);

			if (!data || method === 'GET') {
				xhr.send();
			}
			else {
				xhr.send(data);
			}
		}

		function loadPackage (errorHandler) {
			errorHandler	= errorHandler || abort;

			var hashExists		= 'webSignHash' in LocalStorage;
			var hashExpireDate	= parseInt(LocalStorage.webSignHashExpires, 10);

			if (hashExists && hashExpireDate > Date.now()) {
				request({
					url: WebSign.cdnUrl + WebSign.config.packagePath,
					data: LocalStorage.webSignHash,
					error: errorHandler,
					success: function (payload) {
						Sha256(payload, function (hash) {
							if (hash === LocalStorage.webSignHash) {
								document.open('text/html');
								document.write(payload);
								document.close();
							}
							else {
								errorHandler();
							}
						});
					}
				});
			}
			/* Hash is bad or outdated */
			else {
				errorHandler();
			}
		}

		function setCdnContinent (continent) {
			WebSign.continent	= continent || WebSign.config.defaultContinent;

			WebSign.cdnUrl		=
				WebSign.config.urlProtocol +
				WebSign.continent +
				WebSign.config.cdnUrlBase
			;
		}


		}());</script>
	</body>
</html>
