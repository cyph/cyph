<html><body>

<script>
	var events	= [];
	window.addEventListener('message', function (e) { events.push(e) }, false);
</script>
<script src='/_ah/channel/jsapi'></script>
<script>
	var eventLoopDelay	= 50;
	var channels		= {};

	function callback (eventName, e) {
		return function () {
			e.source.postMessage({
				eventName: eventName,
				args: Array.prototype.slice.call(arguments),
				id: e.data.id
			}, e.origin);
		};
	}

	function eventLoop () {
		try {
			if (events.length) {
				var e	= events.shift();

				switch (e.data.method) {
					case 'new':
						channels[e.data.id]	= {channel: new goog.appengine.Channel(e.data.token)};
						break;

					case 'open':
						var o	= channels[e.data.id];

						o.socket	= o.channel.open({
							onopen: callback('onopen'),
							onmessage: callback('onmessage'),
							onerror: callback('onerror'),
							onclose: callback('onclose')
						});

						eventLoopDelay	= 1000;
						break;

					case 'close':
						channels[e.data.id].socket.close();
						break;
				}
			}
		}
		finally {
			setTimeout(eventLoop, eventLoopDelay);
		}
	}

	eventLoop();
</script>

</body></html>
