<html><body>

<script>
	function dothemove () {
		var channels	= {};

		function postMessageToOrigin (message, e) {
			e.source.postMessage(message, e.origin);
		}

		function callback (eventName, e) {
			return function () {
				postMessageToOrigin({
					eventName: eventName,
					args: Array.prototype.slice.call(arguments),
					id: e.data.id
				}, e);
			};
		}

		window.addEventListener('message', function (e) {
			switch (e.data.method) {
				case 'new':
					channels[e.data.id]	= {channel: new goog.appengine.Channel(e.data.token)};
					break;

				case 'open':
					var o	= channels[e.data.id];

					o.socket	= o.channel.open({
						onopen: callback('onopen', e),
						onmessage: callback('onmessage', e),
						onerror: callback('onerror', e),
						onclose: callback('onclose', e)
					});
					break;

				case 'close':
					channels[e.data.id].socket.close();
					break;

				default:
					postMessageToOrigin({pong: true}, e);
					break;
			}
		}, false);
	}


	var isOnion		= document.location.host.split('.').slice(-1)[0] == 'onion';
	var scriptUrl	= (isOnion ? '/google/talkgadget/' : 'https://talkgadget.google.com/talkgadget/') + 'channel.js';

	function loadScript (src, body) {
		var script	= document.createElement('script');

		if (src) {
			script.src	= src;
		}
		else if (body) {
			script.innerText	= body;
		}

		document.body.appendChild(script);
	}

	loadScript(scriptUrl);
	loadScript(null, 'dothemove()');
</script>

</body></html>
